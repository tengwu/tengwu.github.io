<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>使用flex, bison, llvm实现编译器 | me</title><meta name=keywords content="编译,LLVM"><meta name=description content="2023年实现编译器竟然如此简单 这周跟着LLVM官方教程学习了一下 LLVM 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.
抱着学习 LLVM 的目的,周末突然产生了用 flex, bison, LLVM 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.
参考 https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ 动手写个玩具编译器 链接2 参考了 链接1, 链接1 是2009年写的一篇博客,基于 LLVM 2.6, 链接2 是2020年写的一篇博客,基于更高版本的 LLVM (经过测试, LLVM 9.0.1_4 可以编译通过). 现在是2023年4月2日, LLVM 稳定版本是16.0.0,也许我可以试着把 链接2 的代码改一改,适配 LLVM 16.0.0. 代码适配 LLVM 16.0.0 项目构建 将已有的代码编译通过 LLVM 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 LLVM 版本.
经测试,原始代码使用的C++标准是14, LLVM 版本为 LLVM 9.0.1_4.在 macOS 13.2.1 上,可以通过 brew install llvm@9 来安装这个版本的 LLVM,在安装结束后, brew 会输出安装位置(在这个目录下有 bin, lib, include 等常见目录),在本文中,我们将这个位置称为 LLVM_DIR.例如,在我的系统上, LLVM_DIR 为 /usr/local/Cellar/llvm@9/9.0.1_4.
原始代码中的 Makefile 文件使用 llvm-config 来设置头文件目录和库搜索目录:"><meta name=author content="Me"><link rel=canonical href=http://tengwu.quest/post/2023/04/writing-a-compiler-with-open-source-tools/><link crossorigin=anonymous href=/assets/css/stylesheet.6a98292fb8fa8cf0f3ba4042d4b75515c04267550f3ad49ff6271b5af9562443.css integrity="sha256-apgpL7j6jPDzukBC1LdVFcBCZ1UPOtSf9icbWvlWJEM=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=http://tengwu.quest/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=http://tengwu.quest/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=http://tengwu.quest/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=http://tengwu.quest/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=http://tengwu.quest/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="使用flex, bison, llvm实现编译器"><meta property="og:description" content="2023年实现编译器竟然如此简单 这周跟着LLVM官方教程学习了一下 LLVM 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.
抱着学习 LLVM 的目的,周末突然产生了用 flex, bison, LLVM 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.
参考 https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ 动手写个玩具编译器 链接2 参考了 链接1, 链接1 是2009年写的一篇博客,基于 LLVM 2.6, 链接2 是2020年写的一篇博客,基于更高版本的 LLVM (经过测试, LLVM 9.0.1_4 可以编译通过). 现在是2023年4月2日, LLVM 稳定版本是16.0.0,也许我可以试着把 链接2 的代码改一改,适配 LLVM 16.0.0. 代码适配 LLVM 16.0.0 项目构建 将已有的代码编译通过 LLVM 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 LLVM 版本.
经测试,原始代码使用的C++标准是14, LLVM 版本为 LLVM 9.0.1_4.在 macOS 13.2.1 上,可以通过 brew install llvm@9 来安装这个版本的 LLVM,在安装结束后, brew 会输出安装位置(在这个目录下有 bin, lib, include 等常见目录),在本文中,我们将这个位置称为 LLVM_DIR.例如,在我的系统上, LLVM_DIR 为 /usr/local/Cellar/llvm@9/9.0.1_4.
原始代码中的 Makefile 文件使用 llvm-config 来设置头文件目录和库搜索目录:"><meta property="og:type" content="article"><meta property="og:url" content="http://tengwu.quest/post/2023/04/writing-a-compiler-with-open-source-tools/"><meta property="og:image" content="http://tengwu.quest/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-04-02T14:12:00+08:00"><meta property="article:modified_time" content="2023-04-07T12:56:07+08:00"><meta property="og:site_name" content="ExampleSite"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://tengwu.quest/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta name=twitter:title content="使用flex, bison, llvm实现编译器"><meta name=twitter:description content="2023年实现编译器竟然如此简单 这周跟着LLVM官方教程学习了一下 LLVM 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.
抱着学习 LLVM 的目的,周末突然产生了用 flex, bison, LLVM 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.
参考 https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ 动手写个玩具编译器 链接2 参考了 链接1, 链接1 是2009年写的一篇博客,基于 LLVM 2.6, 链接2 是2020年写的一篇博客,基于更高版本的 LLVM (经过测试, LLVM 9.0.1_4 可以编译通过). 现在是2023年4月2日, LLVM 稳定版本是16.0.0,也许我可以试着把 链接2 的代码改一改,适配 LLVM 16.0.0. 代码适配 LLVM 16.0.0 项目构建 将已有的代码编译通过 LLVM 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 LLVM 版本.
经测试,原始代码使用的C++标准是14, LLVM 版本为 LLVM 9.0.1_4.在 macOS 13.2.1 上,可以通过 brew install llvm@9 来安装这个版本的 LLVM,在安装结束后, brew 会输出安装位置(在这个目录下有 bin, lib, include 等常见目录),在本文中,我们将这个位置称为 LLVM_DIR.例如,在我的系统上, LLVM_DIR 为 /usr/local/Cellar/llvm@9/9.0.1_4.
原始代码中的 Makefile 文件使用 llvm-config 来设置头文件目录和库搜索目录:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://tengwu.quest/post/"},{"@type":"ListItem","position":2,"name":"使用flex, bison, llvm实现编译器","item":"http://tengwu.quest/post/2023/04/writing-a-compiler-with-open-source-tools/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"使用flex, bison, llvm实现编译器","name":"使用flex, bison, llvm实现编译器","description":"2023年实现编译器竟然如此简单 这周跟着LLVM官方教程学习了一下 LLVM 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.\n抱着学习 LLVM 的目的,周末突然产生了用 flex, bison, LLVM 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.\n参考 https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ 动手写个玩具编译器 链接2 参考了 链接1, 链接1 是2009年写的一篇博客,基于 LLVM 2.6, 链接2 是2020年写的一篇博客,基于更高版本的 LLVM (经过测试, LLVM 9.0.1_4 可以编译通过). 现在是2023年4月2日, LLVM 稳定版本是16.0.0,也许我可以试着把 链接2 的代码改一改,适配 LLVM 16.0.0. 代码适配 LLVM 16.0.0 项目构建 将已有的代码编译通过 LLVM 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 LLVM 版本.\n经测试,原始代码使用的C++标准是14, LLVM 版本为 LLVM 9.0.1_4.在 macOS 13.2.1 上,可以通过 brew install llvm@9 来安装这个版本的 LLVM,在安装结束后, brew 会输出安装位置(在这个目录下有 bin, lib, include 等常见目录),在本文中,我们将这个位置称为 LLVM_DIR.例如,在我的系统上, LLVM_DIR 为 /usr/local/Cellar/llvm@9/9.0.1_4.\n原始代码中的 Makefile 文件使用 llvm-config 来设置头文件目录和库搜索目录:","keywords":["编译","LLVM"],"articleBody":"2023年实现编译器竟然如此简单 这周跟着LLVM官方教程学习了一下 LLVM 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.\n抱着学习 LLVM 的目的,周末突然产生了用 flex, bison, LLVM 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.\n参考 https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/ 动手写个玩具编译器 链接2 参考了 链接1, 链接1 是2009年写的一篇博客,基于 LLVM 2.6, 链接2 是2020年写的一篇博客,基于更高版本的 LLVM (经过测试, LLVM 9.0.1_4 可以编译通过). 现在是2023年4月2日, LLVM 稳定版本是16.0.0,也许我可以试着把 链接2 的代码改一改,适配 LLVM 16.0.0. 代码适配 LLVM 16.0.0 项目构建 将已有的代码编译通过 LLVM 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 LLVM 版本.\n经测试,原始代码使用的C++标准是14, LLVM 版本为 LLVM 9.0.1_4.在 macOS 13.2.1 上,可以通过 brew install llvm@9 来安装这个版本的 LLVM,在安装结束后, brew 会输出安装位置(在这个目录下有 bin, lib, include 等常见目录),在本文中,我们将这个位置称为 LLVM_DIR.例如,在我的系统上, LLVM_DIR 为 /usr/local/Cellar/llvm@9/9.0.1_4.\n原始代码中的 Makefile 文件使用 llvm-config 来设置头文件目录和库搜索目录:\n# ... LLVMCONFIG = llvm-config # ... CPPFLAGS = `$(LLVMCONFIG) --cppflags` -std=c++14 LDFLAGS = `$(LLVMCONFIG) --ldflags` -lz -lncurses # ... 关于 llvm-config 的更多资料,参考官方文档.总而言之,这要求我们将 LLVM 9.0.1_4 的 bin 目录放到 PATH 路径最开头,以便 make 能找到合适的 llvm-config.\n设置好上述的一切后,在我的系统上, make compile 会输出以下内容:\nbison -d -o parser.cpp parser.y clang++ -c `llvm-config --cppflags` -std=c++14 -o parser.o parser.cpp clang++ -c `llvm-config --cppflags` -std=c++14 -o codegen.o codegen.cpp clang++ -c `llvm-config --cppflags` -std=c++14 -o main.o main.cpp flex -o tokens.cpp tokens.l parser.hpp clang++ -c `llvm-config --cppflags` -std=c++14 -o tokens.o tokens.cpp clang++ -c `llvm-config --cppflags` -std=c++14 -o corefn.o corefn.cpp clang++ -c `llvm-config --cppflags` -std=c++14 -o native.o native.cpp clang++ -o compiler parser.o codegen.o main.o tokens.o corefn.o native.o `llvm-config --libs` `llvm-config --ldflags` -lz -lncurses ./compiler Generating code... Generating code for 18NExternDeclaration Generating code for 20NFunctionDeclaration Creating variable declaration int a Generating code for 20NVariableDeclaration Creating variable declaration int x Creating assignment for x Creating binary operation 276 Creating identifier reference: a Creating integer: 5 Generating code for 16NReturnStatement Generating return code for 15NBinaryOperator Creating binary operation 274 Creating identifier reference: x Creating integer: 3 Creating block Creating function: do_math Generating code for 20NExpressionStatement Generating code for 11NMethodCall Creating integer: 13 Creating method call: do_math Creating method call: echo Generating code for 20NExpressionStatement Generating code for 11NMethodCall Creating integer: 12 Creating method call: do_math Creating method call: echo Generating code for 20NExpressionStatement Generating code for 11NMethodCall Creating integer: 10 Creating method call: printi Creating block ; ModuleID = 'main' source_filename = \"main\" @.str = private constant [4 x i8] c\"%d\\0A\\00\" declare i32 @printf(i8*, ...) define internal void @echo(i64 %toPrint) { entry: %0 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i64 %toPrint) ret void } define i32 @main() { entry: %0 = call i64 @do_math(i64 13) call void @echo(i64 %0) %1 = call i64 @do_math(i64 12) call void @echo(i64 %1) call void @printi(i64 10) ret i32 0 } declare void @printi(i64) define internal i64 @do_math(i64 %a1) { entry: %a = alloca i64 store i64 %a1, i64* %a %x = alloca i64 %0 = load i64, i64* %a %1 = mul i64 %0, 5 store i64 %1, i64* %x %2 = load i64, i64* %x %3 = add i64 %2, 3 ret i64 %3 } Code is generated. sleep 1 llc test/example.bc -o test/example.S sleep 1 clang++ native.cpp test/example.S -o test/example.native 说明编译成功, example.native 已经是一个可以在我的系统上运行的 ELF 文件:\n$ file test/example.native test/example.native: Mach-O 64-bit executable x86_64 运行它,输出的结果为:\n$ ./test/example.native 68 63 10 使用cmake构建项目 关于 cmake 的基本概念,请参考官方文档.\ncmake 相比于手写 Makefile 有以下优点:\n跨平台支持: cmake 可以生成不同平台下的 Makefile 或IDE项目,可以方便地在不同的操作系统上编译,构建和安装. 自动依赖管理: cmake 能够自动地管理项目中的依赖,包括库文件和头文件等,减少了手动编写 Makefile 的繁琐过程. 更简洁的语法:相比于 Makefile , cmake 的语法更为简洁,易于理解和维护. 多配置支持: cmake 支持多配置构建,可以在一个项目中同时支持Debug和Release等多种构建模式. IDE集成支持: cmake 可以生成各种主流IDE所需的项目文件,如Visual Studio,Xcode,Clion等,方便开发者在自己喜欢的IDE中开发项目. 总的来说, cmake 可以帮助开发者更轻松地管理和构建项目,提高开发效率,减少出错概率,具有良好的可移植性和可扩展性.\n使用 cmake 的方式是为项目编写一个 CMakeLists.txt 文件.\n以下是一个可以编译本项目的 CMakeLists.txt 文件内容:\ncmake_minimum_required(VERSION 3.10) project(toy-compiler) set(CMAKE_CXX_STANDARD 14) file(GLOB CPPS ${CMAKE_SOURCE_DIR}/*.cpp) # Find Flex and Bison packages find_package(FLEX REQUIRED) find_package(BISON REQUIRED) # Define the Flex and Bison input and output files flex_target(Scanner tokens.l ${CMAKE_SOURCE_DIR}/tokens.cpp) bison_target(Parser parser.y ${CMAKE_SOURCE_DIR}/parser.cpp) add_flex_bison_dependency(Scanner Parser) # Use customized LLVM find_package(Clang REQUIRED CONFIG HINTS ${LLVM_DIR} NO_DEFAULT_PATH) include_directories(${LLVM_INCLUDE_DIRS} ${CLANG_INCLUDE_DIRS} SYSTEM) link_directories(${LLVM_LIBRARY_DIRS}) # Add the executable add_executable(compiler ${CPPS} ${BISON_Parser_OUTPUTS} ${FLEX_Scanner_OUTPUTS} ) target_link_libraries(compiler LLVMX86AsmParser LLVMX86CodeGen LLVMAsmParser LLVMBitWriter LLVMRuntimeDyld LLVMExecutionEngine LLVMMCJIT z ncurses ) cmake 提供了一些宏来方便 flex 和 bison 的使用,这些宏包括: flex_target, bison_target, add_flex_bison_dependency 等,具体情况请参考官方文档.\n因为在编写编译器的过程中用到了 LLVM 的许多功能,自然要把 LLVM 的库找到,并将他们链接到最后的二进制文件中,具体代码如下:\n# Use customized LLVM find_package(Clang REQUIRED CONFIG HINTS ${LLVM_DIR} NO_DEFAULT_PATH) include_directories(${LLVM_INCLUDE_DIRS} ${CLANG_INCLUDE_DIRS} SYSTEM) link_directories(${LLVM_LIBRARY_DIRS}) find_package 用来从 ${LLVM_DIR} 这个路径中寻找 Clang 相关的库路径,头文件路径等, include_directories 用来将找到的库路径,头文件路径添加到搜索路径中,使得在编译和链接时能找到相应的文件.\ntarget_link_libraries 用于指定生成的二进制程序需要链接上哪些外部库.\n给项目中添加了上述 CMakeLists.txt 文件后,项目可以正常编译运行.\nfind_package find_package() 是 cmake 中的一个命令,用于在系统上查找已安装的软件包,并设置相关变量.这个命令主要用于在 cmake 构建系统中引入第三方库。\n当使用 find_package() 命令查找软件包时, cmake 会在系统路径下查找该软件包，并设置相关变量,例如该软件包的头文件路径,库文件路径,链接库等信息.一旦成功找到软件包,就可以将其与项目链接起来,使您的项目能够使用该软件包提供的功能.\n通常，使用 find_package() 命令需要执行以下步骤：\n在 CMakeLists.txt 文件中加入 find_package() 命令，例如： find_package(PackageName REQUIRED),这里 的 PackageName 是要查找的软件包名称,如果该软件包不存在或未安装, cmake 将会在输出中报告错误.如果软件包存在, cmake 会设置相关变量,例如包含路径,库文件路径等\n在 CMakeLists.txt 文件中使用 include_directories() 命令或 target_include_directories() 命令将包\u003e含路径添加到项目中 使用 add_library() 或 add_executable() 命令将源文件与该软件包链接起来,例如: add_executable(MyApp main.cpp) target_link_libraries(MyApp PackageName) 这里的 PackageName 是要使用的软件包名称 默认情况下, find_package 会从以下几个地方查找包：\nCMAKE_PREFIX_PATH :这是一个用分号分隔的路径列表, cmake 会在这些路径中查找安装的包 环境变量:如果在 CMAKE_PREFIX_PATH 中找不到包, cmake 会检查环境变量，例如在 linux 上, cmake 会\u003e检查 PKG_CONFIG_PATH 变量 cmake 内置模块: cmake 附带了许多内置模块,用于查找常见的包,比如我们上面使用的 flex 和 bison 模块路径: cmake 允许开发人员编写自己的模块并在 cmake 脚本中使用它们.如果包不在 CMAKE_PREFIX_PATH 或内置模块中,则 cmake 会查找用户定义的模块路径 find_package 会设置一些变量,以便用户在 CMakeLists.txt 文件中使用.这些变量包括:\n_FOUND:用于指示是否找到了包 _INCLUDE_DIRS:用于包含头文件的路径 _LIBRARIES:用于链接库的路径 _DEFINITIONS:用于包含预定义宏的定义 _VERSION:包的版本号 这些变量可以在 CMakeLists.txt 文件中使用,以便正确地包含头文件,链接库等.\nOne More Thing 为什么不需要find_package(LLVM…)?\n在使用 cmake 构建项目时,我发现了一件奇怪的事情: CMakeLists.txt 文件中,只对 Clang 进行了 find_package,并没有对 LLVM 进行 find_package,在最后链接的时候,竟然能链接 LLVM 的库.\n我猜测是在 find_package(Clang...) 时, Clang 去执行了 find_package(LLVM...),查看 ClangConfig.cmake 文件后,果然是这样.在 ${LLVM_DIR}/lib/cmake/clang/ClangConfig.cmake 文件中,有一行 find_package(LLVM REQUIRED CONFIG HINTS \"${CLANG_INSTALL_PREFIX}/lib/cmake/llvm\").\n适配 LLVM 16.0.0 主要是CPP语法+LLVM接口 原始项目中,使用的是C++ 14的语法,但是 LLVM 16.0.0 使用了更新的C++标准,经过测试,C++ 20是可以编译通过的,所以我选择了C++20.\n原始版本使用的是 LLVM 9.0.1_4 的接口,迁移到 LLVM 16.0.0 后,只需要将编译无法通过的接口适配一下既可.\n借鉴Kaleidoscope生成 .o 文件 原始项目产生的编译器会将源文件编译为 BitCode 文件,接着要么使用 llc 和 clang 将 BitCode 编译为可运行的二进制程序,要么使用 lli 解释执行 BitCode 文件.借鉴Kaleidoscope第八章,我们其实可以直接生成 .o 文件,后续再想办法将 .o 文件链接为可执行的二进制程序.\n这一部分的代码直接参考了 Kaleidoscope,改动不是特别大.\n使用LLVM的一些Pass对代码进行优化 这一部分参考了Kaleidoscope第四章的 4.3. LLVM Optimization Passes 一节,只需要在代码生成之后,使用 Pass 对代码进行优化,非常方便,同样代码改动不大.\n后续计划 完善语法 这个小项目目前还不支持分支等很多语法,需要陆续添加 需要支持类型系统 借鉴Kaleidoscope第四章 4.4. Adding a JIT Compiler 一节的最后一部分,使用现有的C库扩充函数 加入一些函数式编程的语法 优化内存管理 完善编译器功能 编译器目前只支持生成 .o 文件,之后需要支持生成可执行的二进制文件,能跨平台更好了 使用 LLVM 的 JIT 加入解释器的功能 ","wordCount":"826","inLanguage":"en","datePublished":"2023-04-02T14:12:00+08:00","dateModified":"2023-04-07T12:56:07+08:00","author":{"@type":"Person","name":"Me"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://tengwu.quest/post/2023/04/writing-a-compiler-with-open-source-tools/"},"publisher":{"@type":"Organization","name":"me","logo":{"@type":"ImageObject","url":"http://tengwu.quest/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://tengwu.quest/ accesskey=h title="me (Alt + H)">me</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://tengwu.quest/categories/ title=categories><span>categories</span></a></li><li><a href=http://tengwu.quest/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://tengwu.quest/>Home</a>&nbsp;»&nbsp;<a href=http://tengwu.quest/post/>Posts</a></div><h1 class=post-title>使用flex, bison, llvm实现编译器</h1><div class=post-meta><span title='2023-04-02 14:12:00 +0800 CST'>April 2, 2023</span>&nbsp;·&nbsp;4 min&nbsp;·&nbsp;826 words&nbsp;·&nbsp;Me&nbsp;|&nbsp;<a href=https://github.com/tengwu/tengwu.github.io/blob/master/content/post/2023/04/writing-a-compiler-with-open-source-tools.md rel="noopener noreferrer" target=_blank>修改建议</a></div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#2023年实现编译器竟然如此简单>2023年实现编译器竟然如此简单</a></li><li><a href=#参考>参考</a></li><li><a href=#代码适配-llvm-16-dot-0-dot-0>代码适配 <code>LLVM 16.0.0</code></a><ul><li><a href=#项目构建>项目构建</a></li><li><a href=#适配-llvm-16-dot-0-dot-0>适配 <code>LLVM 16.0.0</code></a></li><li><a href=#使用llvm的一些pass对代码进行优化>使用LLVM的一些Pass对代码进行优化</a></li><li><a href=#后续计划>后续计划</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=2023年实现编译器竟然如此简单>2023年实现编译器竟然如此简单<a hidden class=anchor aria-hidden=true href=#2023年实现编译器竟然如此简单>#</a></h2><p>这周跟着<a href=https://llvm.org/docs/tutorial/>LLVM官方教程</a>学习了一下 <code>LLVM</code> 的基础知识,实现了一个可以跑起来的编译器,当然其实就是把人家提供的代码稍微改一改,不理解的地方单步跟着调一下.</p><p>抱着学习 <code>LLVM</code> 的目的,周末突然产生了用 <code>flex</code>, <code>bison</code>, <code>LLVM</code> 实现一个编译器的想法,网上搜索了一下,十几年前就有人这样做了,索性就直接跟着别人的博客学习一下.还是先把别人的代码跑起来,读代码,不懂的地方单步跟一下,如果有什么想法的话,再把别人的代码魔改一下.</p><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ol><li><a href=https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/>https://gnuu.org/2009/09/18/writing-your-own-toy-compiler/</a></li><li><a href=https://jeremyxu2010.github.io/2020/10/%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%AA%E7%8E%A9%E5%85%B7%E7%BC%96%E8%AF%91%E5%99%A8/#heading-1>动手写个玩具编译器</a>
<code>链接2</code> 参考了 <code>链接1</code>, <code>链接1</code> 是2009年写的一篇博客,基于 <code>LLVM 2.6</code>, <code>链接2</code> 是2020年写的一篇博客,基于更高版本的 <code>LLVM</code> (经过测试, <code>LLVM 9.0.1_4</code> 可以编译通过).
现在是2023年4月2日, <code>LLVM</code> 稳定版本是16.0.0,也许我可以试着把 <code>链接2</code> 的代码改一改,适配 <code>LLVM 16.0.0</code>.</li></ol><h2 id=代码适配-llvm-16-dot-0-dot-0>代码适配 <code>LLVM 16.0.0</code><a hidden class=anchor aria-hidden=true href=#代码适配-llvm-16-dot-0-dot-0>#</a></h2><h3 id=项目构建>项目构建<a hidden class=anchor aria-hidden=true href=#项目构建>#</a></h3><h4 id=将已有的代码编译通过>将已有的代码编译通过<a hidden class=anchor aria-hidden=true href=#将已有的代码编译通过>#</a></h4><p><code>LLVM</code> 每一个版本的接口都有很大的不同,每个版本使用的C++标准甚至都有差别,为了将已有代码编译通过,需要使用合适的C++标准和 <code>LLVM</code> 版本.</p><p>经测试,原始代码使用的C++标准是14, <code>LLVM</code> 版本为 <code>LLVM 9.0.1_4</code>.在 <code>macOS 13.2.1</code> 上,可以通过 <code>brew install llvm@9</code> 来安装这个版本的 <code>LLVM</code>,在安装结束后, <code>brew</code> 会输出安装位置(在这个目录下有 <code>bin</code>, <code>lib</code>, <code>include</code> 等常见目录),在本文中,我们将这个位置称为 <code>LLVM_DIR</code>.例如,在我的系统上, <code>LLVM_DIR</code> 为 <code>/usr/local/Cellar/llvm@9/9.0.1_4</code>.</p><p>原始代码中的 <code>Makefile</code> 文件使用 <code>llvm-config</code> 来设置头文件目录和库搜索目录:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-makefile data-lang=makefile><span class=line><span class=cl><span class=c># ...
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>LLVMCONFIG</span> <span class=o>=</span> llvm-config
</span></span><span class=line><span class=cl><span class=c># ...
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nv>CPPFLAGS</span> <span class=o>=</span> <span class=sb>`</span><span class=k>$(</span>LLVMCONFIG<span class=k>)</span> --cppflags<span class=sb>`</span> -std<span class=o>=</span>c++14
</span></span><span class=line><span class=cl><span class=nv>LDFLAGS</span> <span class=o>=</span> <span class=sb>`</span><span class=k>$(</span>LLVMCONFIG<span class=k>)</span> --ldflags<span class=sb>`</span> -lz -lncurses
</span></span><span class=line><span class=cl><span class=c># ...
</span></span></span></code></pre></div><p>关于 <code>llvm-config</code> 的更多资料,参考<a href=https://llvm.org/docs/CommandGuide/llvm-config.html>官方文档</a>.总而言之,这要求我们将 <code>LLVM 9.0.1_4</code> 的 <code>bin</code> 目录放到 <code>PATH</code> 路径最开头,以便 <code>make</code> 能找到合适的 <code>llvm-config</code>.</p><p>设置好上述的一切后,在我的系统上, <code>make compile</code> 会输出以下内容:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nt>bison</span> <span class=o>-</span><span class=nt>d</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>parser</span><span class=nc>.cpp</span> <span class=nt>parser</span><span class=nc>.y</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>parser</span><span class=nc>.o</span> <span class=nt>parser</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>codegen</span><span class=nc>.o</span> <span class=nt>codegen</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>main</span><span class=nc>.o</span> <span class=nt>main</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>flex</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>tokens</span><span class=nc>.cpp</span> <span class=nt>tokens</span><span class=nc>.l</span> <span class=nt>parser</span><span class=nc>.hpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>tokens</span><span class=nc>.o</span> <span class=nt>tokens</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>corefn</span><span class=nc>.o</span> <span class=nt>corefn</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>c</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>cppflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>std</span><span class=o>=</span><span class=nt>c</span><span class=o>++</span><span class=nt>14</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>native</span><span class=nc>.o</span> <span class=nt>native</span><span class=nc>.cpp</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>compiler</span> <span class=nt>parser</span><span class=nc>.o</span> <span class=nt>codegen</span><span class=nc>.o</span> <span class=nt>main</span><span class=nc>.o</span> <span class=nt>tokens</span><span class=nc>.o</span> <span class=nt>corefn</span><span class=nc>.o</span> <span class=nt>native</span><span class=nc>.o</span>  <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>libs</span><span class=err>`</span> <span class=err>`</span><span class=nt>llvm-config</span> <span class=o>--</span><span class=nt>ldflags</span><span class=err>`</span> <span class=o>-</span><span class=nt>lz</span> <span class=o>-</span><span class=nt>lncurses</span>
</span></span><span class=line><span class=cl><span class=nc>.</span><span class=o>/</span><span class=nt>compiler</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span><span class=nc>...</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>18NExternDeclaration</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>20NFunctionDeclaration</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>variable</span> <span class=nt>declaration</span> <span class=nt>int</span> <span class=nt>a</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>20NVariableDeclaration</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>variable</span> <span class=nt>declaration</span> <span class=nt>int</span> <span class=nt>x</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>assignment</span> <span class=nt>for</span> <span class=nt>x</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>binary</span> <span class=nt>operation</span> <span class=nt>276</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>identifier</span> <span class=nt>reference</span><span class=nd>:</span> <span class=nt>a</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>integer</span><span class=nd>:</span> <span class=nt>5</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>16NReturnStatement</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>return</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>15NBinaryOperator</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>binary</span> <span class=nt>operation</span> <span class=nt>274</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>identifier</span> <span class=nt>reference</span><span class=nd>:</span> <span class=nt>x</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>integer</span><span class=nd>:</span> <span class=nt>3</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>block</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>function</span><span class=nd>:</span> <span class=nt>do_math</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>20NExpressionStatement</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>11NMethodCall</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>integer</span><span class=nd>:</span> <span class=nt>13</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>method</span> <span class=nt>call</span><span class=nd>:</span> <span class=nt>do_math</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>method</span> <span class=nt>call</span><span class=nd>:</span> <span class=nt>echo</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>20NExpressionStatement</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>11NMethodCall</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>integer</span><span class=nd>:</span> <span class=nt>12</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>method</span> <span class=nt>call</span><span class=nd>:</span> <span class=nt>do_math</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>method</span> <span class=nt>call</span><span class=nd>:</span> <span class=nt>echo</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>20NExpressionStatement</span>
</span></span><span class=line><span class=cl><span class=nt>Generating</span> <span class=nt>code</span> <span class=nt>for</span> <span class=nt>11NMethodCall</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>integer</span><span class=nd>:</span> <span class=nt>10</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>method</span> <span class=nt>call</span><span class=nd>:</span> <span class=nt>printi</span>
</span></span><span class=line><span class=cl><span class=nt>Creating</span> <span class=nt>block</span>
</span></span><span class=line><span class=cl><span class=p>;</span> <span class=nt>ModuleID</span> <span class=o>=</span> <span class=s1>&#39;main&#39;</span>
</span></span><span class=line><span class=cl><span class=nt>source_filename</span> <span class=o>=</span> <span class=s2>&#34;main&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=o>@</span><span class=nc>.str</span> <span class=o>=</span> <span class=nt>private</span> <span class=nt>constant</span> <span class=o>[</span><span class=nt>4</span> <span class=nt>x</span> <span class=nt>i8</span><span class=o>]</span> <span class=nt>c</span><span class=s2>&#34;%d\0A\00&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>declare</span> <span class=nt>i32</span> <span class=o>@</span><span class=nt>printf</span><span class=o>(</span><span class=nt>i8</span><span class=o>*,</span> <span class=nc>...</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>define</span> <span class=nt>internal</span> <span class=nt>void</span> <span class=o>@</span><span class=nt>echo</span><span class=o>(</span><span class=nt>i64</span> <span class=o>%</span><span class=nc>toPrint</span><span class=o>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>entry</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=mi>0</span> <span class=o>=</span> <span class=n>call</span> <span class=n>i32</span> <span class=p>(</span><span class=n>i8</span><span class=o>*,</span> <span class=o>...</span><span class=p>)</span> <span class=o>@</span><span class=nf>printf</span><span class=p>(</span><span class=n>i8</span><span class=o>*</span> <span class=n>getelementptr</span> <span class=n>inbounds</span> <span class=p>([</span><span class=mi>4</span> <span class=ni>x</span> <span class=n>i8</span><span class=p>]</span><span class=o>,</span> <span class=p>[</span><span class=mi>4</span> <span class=ni>x</span> <span class=n>i8</span><span class=p>]</span><span class=o>*</span> <span class=o>@.</span><span class=n>str</span><span class=o>,</span> <span class=n>i32</span> <span class=mi>0</span><span class=o>,</span> <span class=n>i32</span> <span class=mi>0</span><span class=p>)</span><span class=o>,</span> <span class=n>i64</span> <span class=o>%</span><span class=n>toPrint</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=n>void</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>define</span> <span class=nt>i32</span> <span class=o>@</span><span class=nt>main</span><span class=o>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=nt>entry</span><span class=nd>:</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=nc>0</span> <span class=o>=</span> <span class=nt>call</span> <span class=nt>i64</span> <span class=o>@</span><span class=nt>do_math</span><span class=o>(</span><span class=nt>i64</span> <span class=nt>13</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nt>call</span> <span class=nt>void</span> <span class=o>@</span><span class=nt>echo</span><span class=o>(</span><span class=nt>i64</span> <span class=o>%</span><span class=nc>0</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=nc>1</span> <span class=o>=</span> <span class=nt>call</span> <span class=nt>i64</span> <span class=o>@</span><span class=nt>do_math</span><span class=o>(</span><span class=nt>i64</span> <span class=nt>12</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nt>call</span> <span class=nt>void</span> <span class=o>@</span><span class=nt>echo</span><span class=o>(</span><span class=nt>i64</span> <span class=o>%</span><span class=nc>1</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nt>call</span> <span class=nt>void</span> <span class=o>@</span><span class=nt>printi</span><span class=o>(</span><span class=nt>i64</span> <span class=nt>10</span><span class=o>)</span>
</span></span><span class=line><span class=cl>  <span class=nt>ret</span> <span class=nt>i32</span> <span class=nt>0</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>declare</span> <span class=nt>void</span> <span class=o>@</span><span class=nt>printi</span><span class=o>(</span><span class=nt>i64</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>define</span> <span class=nt>internal</span> <span class=nt>i64</span> <span class=o>@</span><span class=nt>do_math</span><span class=o>(</span><span class=nt>i64</span> <span class=o>%</span><span class=nc>a1</span><span class=o>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl><span class=na>entry</span><span class=o>:</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=n>a</span> <span class=o>=</span> <span class=n>alloca</span> <span class=n>i64</span>
</span></span><span class=line><span class=cl>  <span class=n>store</span> <span class=n>i64</span> <span class=o>%</span><span class=n>a1</span><span class=o>,</span> <span class=n>i64</span><span class=o>*</span> <span class=o>%</span><span class=n>a</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=ni>x</span> <span class=o>=</span> <span class=n>alloca</span> <span class=n>i64</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=mi>0</span> <span class=o>=</span> <span class=n>load</span> <span class=n>i64</span><span class=o>,</span> <span class=n>i64</span><span class=o>*</span> <span class=o>%</span><span class=n>a</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=mi>1</span> <span class=o>=</span> <span class=n>mul</span> <span class=n>i64</span> <span class=o>%</span><span class=mi>0</span><span class=o>,</span> <span class=mi>5</span>
</span></span><span class=line><span class=cl>  <span class=n>store</span> <span class=n>i64</span> <span class=o>%</span><span class=mi>1</span><span class=o>,</span> <span class=n>i64</span><span class=o>*</span> <span class=o>%</span><span class=ni>x</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=mi>2</span> <span class=o>=</span> <span class=n>load</span> <span class=n>i64</span><span class=o>,</span> <span class=n>i64</span><span class=o>*</span> <span class=o>%</span><span class=ni>x</span>
</span></span><span class=line><span class=cl>  <span class=o>%</span><span class=mi>3</span> <span class=o>=</span> <span class=ni>add</span> <span class=n>i64</span> <span class=o>%</span><span class=mi>2</span><span class=o>,</span> <span class=mi>3</span>
</span></span><span class=line><span class=cl>  <span class=n>ret</span> <span class=n>i64</span> <span class=o>%</span><span class=mi>3</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=nt>Code</span> <span class=nt>is</span> <span class=nt>generated</span><span class=nc>.</span>
</span></span><span class=line><span class=cl><span class=nt>sleep</span> <span class=nt>1</span>
</span></span><span class=line><span class=cl><span class=nt>llc</span> <span class=nt>test</span><span class=o>/</span><span class=nt>example</span><span class=nc>.bc</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>test</span><span class=o>/</span><span class=nt>example</span><span class=nc>.S</span>
</span></span><span class=line><span class=cl><span class=nt>sleep</span> <span class=nt>1</span>
</span></span><span class=line><span class=cl><span class=nt>clang</span><span class=o>++</span> <span class=nt>native</span><span class=nc>.cpp</span> <span class=nt>test</span><span class=o>/</span><span class=nt>example</span><span class=nc>.S</span> <span class=o>-</span><span class=nt>o</span> <span class=nt>test</span><span class=o>/</span><span class=nt>example</span><span class=nc>.native</span>
</span></span></code></pre></div><p>说明编译成功, <code>example.native</code> 已经是一个可以在我的系统上运行的 <code>ELF</code> 文件:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ file test/example.native
</span></span><span class=line><span class=cl>test/example.native: Mach-O 64-bit executable x86_64
</span></span></code></pre></div><p>运行它,输出的结果为:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ ./test/example.native
</span></span><span class=line><span class=cl><span class=m>68</span>
</span></span><span class=line><span class=cl><span class=m>63</span>
</span></span><span class=line><span class=cl><span class=m>10</span>
</span></span></code></pre></div><h4 id=使用cmake构建项目>使用cmake构建项目<a hidden class=anchor aria-hidden=true href=#使用cmake构建项目>#</a></h4><p>关于 <code>cmake</code> 的基本概念,请参考官方文档.</p><p><code>cmake</code> 相比于手写 <code>Makefile</code> 有以下优点:</p><ol><li>跨平台支持: <code>cmake</code> 可以生成不同平台下的 <code>Makefile</code> 或IDE项目,可以方便地在不同的操作系统上编译,构建和安装.</li><li>自动依赖管理: <code>cmake</code> 能够自动地管理项目中的依赖,包括库文件和头文件等,减少了手动编写 <code>Makefile</code> 的繁琐过程.</li><li>更简洁的语法:相比于 <code>Makefile</code> , <code>cmake</code> 的语法更为简洁,易于理解和维护.</li><li>多配置支持: <code>cmake</code> 支持多配置构建,可以在一个项目中同时支持Debug和Release等多种构建模式.</li><li>IDE集成支持: <code>cmake</code> 可以生成各种主流IDE所需的项目文件,如Visual Studio,Xcode,Clion等,方便开发者在自己喜欢的IDE中开发项目.</li></ol><p>总的来说, <code>cmake</code> 可以帮助开发者更轻松地管理和构建项目,提高开发效率,减少出错概率,具有良好的可移植性和可扩展性.</p><p>使用 <code>cmake</code> 的方式是为项目编写一个 <code>CMakeLists.txt</code> 文件.</p><p>以下是一个可以编译本项目的 <code>CMakeLists.txt</code> 文件内容:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cmake data-lang=cmake><span class=line><span class=cl><span class=nb>cmake_minimum_required</span><span class=p>(</span><span class=s>VERSION</span> <span class=s>3.10</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>project</span><span class=p>(</span><span class=s>toy-compiler</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>set</span><span class=p>(</span><span class=s>CMAKE_CXX_STANDARD</span> <span class=s>14</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>file</span><span class=p>(</span><span class=s>GLOB</span> <span class=s>CPPS</span> <span class=o>${</span><span class=nv>CMAKE_SOURCE_DIR</span><span class=o>}</span><span class=s>/*.cpp</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Find Flex and Bison packages
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>find_package</span><span class=p>(</span><span class=s>FLEX</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>find_package</span><span class=p>(</span><span class=s>BISON</span> <span class=s>REQUIRED</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Define the Flex and Bison input and output files
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>flex_target</span><span class=p>(</span><span class=s>Scanner</span> <span class=s>tokens.l</span> <span class=o>${</span><span class=nv>CMAKE_SOURCE_DIR</span><span class=o>}</span><span class=s>/tokens.cpp</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>bison_target</span><span class=p>(</span><span class=s>Parser</span> <span class=s>parser.y</span> <span class=o>${</span><span class=nv>CMAKE_SOURCE_DIR</span><span class=o>}</span><span class=s>/parser.cpp</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>add_flex_bison_dependency</span><span class=p>(</span><span class=s>Scanner</span> <span class=s>Parser</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Use customized LLVM
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>find_package</span><span class=p>(</span><span class=s>Clang</span> <span class=s>REQUIRED</span> <span class=s>CONFIG</span> <span class=s>HINTS</span> <span class=o>${</span><span class=nv>LLVM_DIR</span><span class=o>}</span> <span class=s>NO_DEFAULT_PATH</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>include_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>LLVM_INCLUDE_DIRS</span><span class=o>}</span> <span class=o>${</span><span class=nv>CLANG_INCLUDE_DIRS</span><span class=o>}</span> <span class=s>SYSTEM</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>link_directories</span><span class=p>(</span><span class=o>${</span><span class=nv>LLVM_LIBRARY_DIRS</span><span class=o>}</span><span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=c># Add the executable
</span></span></span><span class=line><span class=cl><span class=c></span><span class=nb>add_executable</span><span class=p>(</span><span class=s>compiler</span>
</span></span><span class=line><span class=cl>        <span class=o>${</span><span class=nv>CPPS</span><span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>${</span><span class=nv>BISON_Parser_OUTPUTS</span><span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>${</span><span class=nv>FLEX_Scanner_OUTPUTS</span><span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=err>
</span></span></span><span class=line><span class=cl><span class=err>
</span></span></span><span class=line><span class=cl><span class=err></span><span class=nb>target_link_libraries</span><span class=p>(</span><span class=s>compiler</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMX86AsmParser</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMX86CodeGen</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMAsmParser</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMBitWriter</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMRuntimeDyld</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMExecutionEngine</span>
</span></span><span class=line><span class=cl>        <span class=s>LLVMMCJIT</span>
</span></span><span class=line><span class=cl>        <span class=s>z</span>
</span></span><span class=line><span class=cl>        <span class=s>ncurses</span>
</span></span><span class=line><span class=cl>        <span class=p>)</span><span class=err>
</span></span></span></code></pre></div><p><code>cmake</code> 提供了一些宏来方便 <code>flex</code> 和 <code>bison</code> 的使用,这些宏包括: <code>flex_target</code>, <code>bison_target</code>, <code>add_flex_bison_dependency</code> 等,具体情况请参考官方文档.</p><p>因为在编写编译器的过程中用到了 <code>LLVM</code> 的许多功能,自然要把 <code>LLVM</code> 的库找到,并将他们链接到最后的二进制文件中,具体代码如下:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-scss data-lang=scss><span class=line><span class=cl><span class=nn>#</span> <span class=nt>Use</span> <span class=nt>customized</span> <span class=nt>LLVM</span>
</span></span><span class=line><span class=cl><span class=nt>find_package</span><span class=o>(</span><span class=nt>Clang</span> <span class=nt>REQUIRED</span> <span class=nt>CONFIG</span> <span class=nt>HINTS</span> <span class=err>$</span><span class=p>{</span><span class=nt>LLVM_DIR</span><span class=p>}</span> <span class=nt>NO_DEFAULT_PATH</span><span class=o>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>include_directories</span><span class=o>(</span><span class=err>$</span><span class=p>{</span><span class=nt>LLVM_INCLUDE_DIRS</span><span class=p>}</span> <span class=err>$</span><span class=p>{</span><span class=nt>CLANG_INCLUDE_DIRS</span><span class=p>}</span> <span class=nt>SYSTEM</span><span class=o>)</span>
</span></span><span class=line><span class=cl><span class=nt>link_directories</span><span class=o>(</span><span class=err>$</span><span class=p>{</span><span class=nt>LLVM_LIBRARY_DIRS</span><span class=p>})</span>
</span></span></code></pre></div><p><code>find_package</code> 用来从 <code>${LLVM_DIR}</code> 这个路径中寻找 <code>Clang</code> 相关的库路径,头文件路径等, <code>include_directories</code> 用来将找到的库路径,头文件路径添加到搜索路径中,使得在编译和链接时能找到相应的文件.</p><p><code>target_link_libraries</code> 用于指定生成的二进制程序需要链接上哪些外部库.</p><p>给项目中添加了上述 <code>CMakeLists.txt</code> 文件后,项目可以正常编译运行.</p><h4 id=find-package>find_package<a hidden class=anchor aria-hidden=true href=#find-package>#</a></h4><p><code>find_package()</code> 是 <code>cmake</code> 中的一个命令,用于在系统上查找已安装的软件包,并设置相关变量.这个命令主要用于在
<code>cmake</code> 构建系统中引入第三方库。</p><p>当使用 <code>find_package()</code> 命令查找软件包时, <code>cmake</code> 会在系统路径下查找该软件包，并设置相关变量,例如该软件包的头文件路径,库文件路径,链接库等信息.一旦成功找到软件包,就可以将其与项目链接起来,使您的项目能够使用该软件包提供的功能.</p><p>通常，使用 <code>find_package()</code> 命令需要执行以下步骤：</p><ol><li>在 <code>CMakeLists.txt</code> 文件中加入 <code>find_package()</code> 命令，例如： <code>find_package(PackageName REQUIRED)</code>,这里</li></ol><p>的 <code>PackageName</code> 是要查找的软件包名称,如果该软件包不存在或未安装, <code>cmake</code> 将会在输出中报告错误.如果软件包存在, <code>cmake</code> 会设置相关变量,例如包含路径,库文件路径等</p><ol><li>在 <code>CMakeLists.txt</code> 文件中使用 <code>include_directories()</code> 命令或 <code>target_include_directories()</code> 命令将包>含路径添加到项目中</li><li>使用 <code>add_library()</code> 或 <code>add_executable()</code> 命令将源文件与该软件包链接起来,例如:<pre tabindex=0><code class=language-nil data-lang=nil>add_executable(MyApp main.cpp)
target_link_libraries(MyApp PackageName)
</code></pre>这里的 <code>PackageName</code> 是要使用的软件包名称</li></ol><p>默认情况下, <code>find_package</code> 会从以下几个地方查找包：</p><ol><li><code>CMAKE_PREFIX_PATH</code> :这是一个用分号分隔的路径列表, <code>cmake</code> 会在这些路径中查找安装的包</li><li>环境变量:如果在 <code>CMAKE_PREFIX_PATH</code> 中找不到包, <code>cmake</code> 会检查环境变量，例如在 <code>linux</code> 上, <code>cmake</code> 会>检查 <code>PKG_CONFIG_PATH</code> 变量</li><li><code>cmake</code> 内置模块: <code>cmake</code> 附带了许多内置模块,用于查找常见的包,比如我们上面使用的 <code>flex</code> 和 <code>bison</code></li><li>模块路径: <code>cmake</code> 允许开发人员编写自己的模块并在 <code>cmake</code> 脚本中使用它们.如果包不在 <code>CMAKE_PREFIX_PATH</code> 或内置模块中,则 <code>cmake</code> 会查找用户定义的模块路径</li></ol><p><code>find_package</code> 会设置一些变量,以便用户在 <code>CMakeLists.txt</code> 文件中使用.这些变量包括:</p><ol><li><code>&lt;PackageName>_FOUND</code>:用于指示是否找到了包</li><li><code>&lt;PackageName>_INCLUDE_DIRS</code>:用于包含头文件的路径</li><li><code>&lt;PackageName>_LIBRARIES</code>:用于链接库的路径</li><li><code>&lt;PackageName>_DEFINITIONS</code>:用于包含预定义宏的定义</li><li><code>&lt;PackageName>_VERSION</code>:包的版本号</li></ol><p>这些变量可以在 <code>CMakeLists.txt</code> 文件中使用,以便正确地包含头文件,链接库等.</p><h4 id=one-more-thing>One More Thing<a hidden class=anchor aria-hidden=true href=#one-more-thing>#</a></h4><ul><li><p>为什么不需要find_package(LLVM&mldr;)?</p><p>在使用 <code>cmake</code> 构建项目时,我发现了一件奇怪的事情: <code>CMakeLists.txt</code> 文件中,只对 <code>Clang</code> 进行了 <code>find_package</code>,并没有对 <code>LLVM</code> 进行 <code>find_package</code>,在最后链接的时候,竟然能链接 <code>LLVM</code> 的库.</p><p>我猜测是在 <code>find_package(Clang...)</code> 时, <code>Clang</code> 去执行了 <code>find_package(LLVM...)</code>,查看 <code>ClangConfig.cmake</code> 文件后,果然是这样.在 <code>${LLVM_DIR}/lib/cmake/clang/ClangConfig.cmake</code> 文件中,有一行 <code>find_package(LLVM REQUIRED CONFIG HINTS "${CLANG_INSTALL_PREFIX}/lib/cmake/llvm")</code>.</p></li></ul><h3 id=适配-llvm-16-dot-0-dot-0>适配 <code>LLVM 16.0.0</code><a hidden class=anchor aria-hidden=true href=#适配-llvm-16-dot-0-dot-0>#</a></h3><h4 id=主要是cpp语法-plus-llvm接口>主要是CPP语法+LLVM接口<a hidden class=anchor aria-hidden=true href=#主要是cpp语法-plus-llvm接口>#</a></h4><p>原始项目中,使用的是C++ 14的语法,但是 <code>LLVM 16.0.0</code> 使用了更新的C++标准,经过测试,C++ 20是可以编译通过的,所以我选择了C++20.</p><p>原始版本使用的是 <code>LLVM 9.0.1_4</code> 的接口,迁移到 <code>LLVM 16.0.0</code> 后,只需要将编译无法通过的接口适配一下既可.</p><h4 id=借鉴-kaleidoscope-生成-dot-o-文件>借鉴<a href=https://llvm.org/docs/tutorial/index.html>Kaleidoscope</a>生成 <code>.o</code> 文件<a hidden class=anchor aria-hidden=true href=#借鉴-kaleidoscope-生成-dot-o-文件>#</a></h4><p>原始项目产生的编译器会将源文件编译为 <code>BitCode</code> 文件,接着要么使用 <code>llc</code> 和 <code>clang</code> 将 <code>BitCode</code> 编译为可运行的二进制程序,要么使用 <code>lli</code> 解释执行 <code>BitCode</code> 文件.借鉴<a href=https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/LangImpl08.html>Kaleidoscope第八章</a>,我们其实可以直接生成 <code>.o</code> 文件,后续再想办法将 <code>.o</code> 文件链接为可执行的二进制程序.</p><p>这一部分的代码直接参考了 <code>Kaleidoscope</code>,改动不是特别大.</p><h3 id=使用llvm的一些pass对代码进行优化>使用LLVM的一些Pass对代码进行优化<a hidden class=anchor aria-hidden=true href=#使用llvm的一些pass对代码进行优化>#</a></h3><p>这一部分参考了<a href=https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/LangImpl04.html>Kaleidoscope第四章</a>的 <code>4.3. LLVM Optimization Passes</code> 一节,只需要在代码生成之后,使用 <code>Pass</code> 对代码进行优化,非常方便,同样代码改动不大.</p><h3 id=后续计划>后续计划<a hidden class=anchor aria-hidden=true href=#后续计划>#</a></h3><h4 id=完善语法>完善语法<a hidden class=anchor aria-hidden=true href=#完善语法>#</a></h4><ol><li>这个小项目目前还不支持分支等很多语法,需要陆续添加</li><li>需要支持类型系统</li><li>借鉴<a href=https://llvm.org/docs/tutorial/MyFirstLanguageFrontend/LangImpl04.html>Kaleidoscope第四章</a> <code>4.4. Adding a JIT Compiler</code> 一节的最后一部分,使用现有的C库扩充函数</li><li>加入一些函数式编程的语法</li><li>优化内存管理</li></ol><h4 id=完善编译器功能>完善编译器功能<a hidden class=anchor aria-hidden=true href=#完善编译器功能>#</a></h4><ol><li>编译器目前只支持生成 <code>.o</code> 文件,之后需要支持生成可执行的二进制文件,能跨平台更好了</li><li>使用 <code>LLVM</code> 的 <code>JIT</code> 加入解释器的功能</li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=http://tengwu.quest/tags/%E7%BC%96%E8%AF%91/>编译</a></li><li><a href=http://tengwu.quest/tags/llvm/>LLVM</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=http://tengwu.quest/>me</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>